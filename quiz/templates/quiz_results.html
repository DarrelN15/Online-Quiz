{% extends 'base.html' %}
{% load static %}

{% block title %}Quiz Results{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Quiz Results</h2>
    
    <!-- Filtering and Search controls -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-2">
                <label for="user">User:</label>
                <input type="text" name="user" id="user" class="form-control" placeholder="User" value="{{ user_filter|default_if_none:'' }}">
            </div>        
            <div class="col-md-2">
                <label for="quiz">Quiz:</label>
                <input type="text" name="quiz" id="quiz" class="form-control" placeholder="Quiz" value="{{ quiz_filter|default_if_none:'' }}">
            </div>        
            <div class="col-md-2">
                <label for="date_from">Date From:</label>
                <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <label for="date_to">Date To:</label>
                <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to }}">
            </div>
            <div class="col-md-2">
                <label for="score_min">Min Score:</label>
                <input type="number" name="score_min" id="score_min" class="form-control" value="{{ score_min }}">
            </div>
            <div class="col-md-2">
                <label for="score_max">Max Score:</label>
                <input type="number" name="score_max" id="score_max" class="form-control" value="{{ score_max }}">
            </div>
        </div>
        
        <!-- Search bar -->
        <div class="row mt-3">
            <div class="col-md-4">
                <label for="search">Search:</label>
                <input type="text" name="search" id="search" class="form-control" placeholder="Search" value="{{ search_query|default_if_none:'' }}">
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-2">
                <label for="sort_by">Sort by:</label>
                <select name="sort_by" id="sort_by" class="form-control">
                    <option value="date_taken" {% if sort_by == 'date_taken' %}selected{% endif %}>Date Taken</option>
                    <option value="percentage" {% if sort_by == 'percentage' %}selected{% endif %}>Percentage</option>
                    <option value="score" {% if sort_by == 'score' %}selected{% endif %}>Score</option>
                    <option value="user" {% if sort_by == 'user' %}selected{% endif %}>User</option>
                    <option value="quiz_title" {% if sort_by == 'quiz_title' %}selected{% endif %}>Quiz Title</option>
                </select>
            </div>
            <div class="col-md-2 align-self-end">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>
    
    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Quiz</th>
                <th>Avg. Percentage</th>
                <th>Avg. Score</th>
                <th>Date Taken</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for item in page_obj %}
            <tr>
                <td>{{ item.attempt.user.username }}</td>
                <td>{{ item.attempt.quiz.title }}</td>
                <td>
                    <span class="badge {{ item.badge_color }}">{{ item.percentage_score|floatformat:2 }}%</span>
                </td>
                <td>{{ item.attempt.score }} / {{ item.total_questions }}</td>
                <td>{{ item.attempt.date_taken }}</td>
                <td><a href="{% url 'quiz_attempt_detail' item.attempt.id %}">View Details</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
{% endblock %}

{% comment %} {% extends 'base.html' %}
{% load static %}

{% block title %}Quiz Results{% endblock %}

{% block extra_css %}
<!-- Include Bootstrap CSS from CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Quiz Results</h2>
    
    <!-- Filter Button -->
    <button id="toggleFilterButton" class="btn btn-info mb-4" type="button">
        Filter
    </button>
    
    <!-- Collapsible Filter Section -->
    <div id="filterSection" style="display: none;">
        <form method="get" class="mb-4">
            <div class="row">
                <div class="col-md-2">
                    <label for="user">User:</label>
                    <input type="text" name="user" id="user" class="form-control" placeholder="User" value="{{ user_filter|default_if_none:'' }}">
                </div>
                <div class="col-md-2">
                    <label for="quiz">Quiz:</label>
                    <input type="text" name="quiz" id="quiz" class="form-control" placeholder="Quiz" value="{{ quiz_filter|default_if_none:'' }}">
                </div>
                <div class="col-md-2">
                    <label for="date_from">Date From:</label>
                    <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to">Date To:</label>
                    <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to }}">
                </div>
                <div class="col-md-2">
                    <label for="score_min">Min Score:</label>
                    <input type="number" name="score_min" id="score_min" class="form-control" value="{{ score_min }}">
                </div>
                <div class="col-md-2">
                    <label for="score_max">Max Score:</label>
                    <input type="number" name="score_max" id="score_max" class="form-control" value="{{ score_max }}">
                </div>
            </div>
            
            <!-- Search bar -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <label for="search">Search:</label>
                    <input type="text" name="search" id="search" class="form-control" placeholder="Search" value="{{ search_query|default_if_none:'' }}">
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-2">
                    <label for="sort_by">Sort by:</label>
                    <select name="sort_by" id="sort_by" class="form-control">
                        <option value="date_taken" {% if sort_by == 'date_taken' %}selected{% endif %}>Date Taken</option>
                        <option value="percentage" {% if sort_by == 'percentage' %}selected{% endif %}>Percentage</option>
                        <option value="score" {% if sort_by == 'score' %}selected{% endif %}>Score</option>
                        <option value="user" {% if sort_by == 'user' %}selected{% endif %}>User</option>
                        <option value="quiz_title" {% if sort_by == 'quiz_title' %}selected{% endif %}>Quiz Title</option>
                    </select>
                </div>
                <div class="col-md-2 align-self-end">
                    <button type="submit" class="btn btn-primary">Filter</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Quiz Results Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>User</th>
                <th>Quiz</th>
                <th>Avg. Percentage</th>
                <th>Avg. Score</th>
                <th>Date Taken</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for item in page_obj %}
            <tr>
                <td>{{ item.attempt.user.username }}</td>
                <td>{{ item.attempt.quiz.title }}</td>
                <td>
                    <span class="badge {{ item.badge_color }}">{{ item.percentage_score|floatformat:2 }}%</span>
                </td>
                <td>{{ item.attempt.score }} / {{ item.total_questions }}</td>
                <td>{{ item.attempt.date_taken }}</td>
                <td><a href="{% url 'quiz_attempt_detail' item.attempt.id %}">View Details</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max {{ score_max }}&quiz={{ quiz_filter }}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&sort_by={{ sort_by }}&user={{ user_filter }}&date_from={{ date_from }}&date_to={{ date_to }}&score_min={{ score_min }}&score_max={{ score_max }}&quiz={{ quiz_filter }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<div class="col-md-1 text-center mt-4">
    <small>Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }}</small>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include jQuery and Bootstrap JS from CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<!-- Toggle filter section -->
<script>
    document.getElementById('toggleFilterButton').addEventListener('click', function() {
        var filterSection = document.getElementById('filterSection');
        if (filterSection.style.display === 'none' || filterSection.style.display === '') {
            filterSection.style.display = 'block';
        } else {
            filterSection.style.display = 'none';
        }
    });
</script>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filtersForm = document.querySelector('form');
        const inputs = filtersForm.querySelectorAll('input, select');
    
        inputs.forEach(input => {
            const cookieValue = getCookie(input.name);
            if (cookieValue) {
                input.value = cookieValue;
            }
    
            input.addEventListener('change', () => {
                setCookie(input.name, input.value, 7); // Cookie expires in 7 days
            });
        });
    
        filtersForm.addEventListener('submit', () => {
            inputs.forEach(input => {
                setCookie(input.name, input.value, 7); // Cookie expires in 7 days
            });
        });
    });
    
    function getCookie(name) {
        const value = ; ${document.cookie};
        const parts = value.split(; ${name}=);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function clearFilters() {
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            setCookie(input.name, '', -1); // Expire the cookie
            input.value = ''; // Reset the input value
        });
        window.location.href = window.location.pathname; // Reload the page without query parameters
    }

    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }
</script> 


</html> {% endcomment %}